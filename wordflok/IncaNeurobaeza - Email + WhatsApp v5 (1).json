{
  "name": "IncaNeurobaeza - Email + WhatsApp v5",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "incapacidades",
        "options": {}
      },
      "id": "9bc8d7aa-e015-4012-b7e9-1e140271327e",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -400,
        112
      ],
      "webhookId": "incapacidades"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.body;\n\n// ========== PROCESAR EMAILS CC ==========\nlet cc_emails = [];\n\nif (data.cc_email && data.cc_email.trim()) {\n  cc_emails = data.cc_email\n    .split(',')\n    .map(e => e.trim())\n    .filter(e => e.includes('@') && e.length > 5);\n}\n\n// Eliminar duplicados (case-insensitive)\nconst uniqueEmails = new Set();\ncc_emails = cc_emails.filter(email => {\n  const lowerEmail = email.toLowerCase();\n  if (uniqueEmails.has(lowerEmail)) {\n    return false;\n  }\n  uniqueEmails.add(lowerEmail);\n  return true;\n});\n\n// Eliminar el TO de los CCs si estÃ¡ incluido\nif (data.email) {\n  const toLower = data.email.toLowerCase();\n  cc_emails = cc_emails.filter(e => e.toLowerCase() !== toLower);\n}\n\n// ========== PROCESAR TELÃ‰FONOS WHATSAPP ==========\nlet whatsapp_numbers = [];\n\nif (data.whatsapp && data.whatsapp.trim()) {\n  whatsapp_numbers = data.whatsapp\n    .split(',')\n    .map(num => {\n      // Limpiar nÃºmero (solo dÃ­gitos y +)\n      let clean = num.trim().replace(/[^0-9+]/g, '');\n      \n      // Formato Colombia: +57XXXXXXXXXX (12 dÃ­gitos)\n      if (clean.startsWith('+57')) {\n        return clean; // Ya tiene formato correcto\n      }\n      if (clean.startsWith('57') && clean.length === 12) {\n        return '+' + clean; // Agregar +\n      }\n      if (clean.length === 10) {\n        return '+57' + clean; // NÃºmero colombiano sin cÃ³digo\n      }\n      return clean;\n    })\n    .filter(num => num.length >= 12); // MÃ­nimo +57 + 10 dÃ­gitos\n}\n\n// ========== CONVERTIR HTML A TEXTO PARA WHATSAPP ==========\nlet whatsapp_text = data.whatsapp_message || '';\n\nif (!data.whatsapp_message && data.html_content) {\n  // Extraer texto limpio del HTML\n  whatsapp_text = data.html_content\n    .replace(/<style[^>]*>.*?<\\/style>/gi, '') // Quitar CSS\n    .replace(/<script[^>]*>.*?<\\/script>/gi, '') // Quitar JS\n    .replace(/<br\\s*\\/?>/gi, '\\n')              // BR a salto de lÃ­nea\n    .replace(/<\\/p>/gi, '\\n\\n')                 // PÃ¡rrafos\n    .replace(/<\\/div>/gi, '\\n')                 // Divs\n    .replace(/<li>/gi, 'â€¢ ')                      // Listas\n    .replace(/<[^>]+>/g, '')                      // Quitar todos los tags\n    .replace(/&nbsp;/g, ' ')                      // Entities\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/\\n{3,}/g, '\\n\\n')                  // MÃ¡ximo 2 saltos seguidos\n    .replace(/[ \\t]+/g, ' ')                      // MÃºltiples espacios\n    .trim();\n  \n  // Limitar a 1500 caracteres (WhatsApp permite ~4096)\n  if (whatsapp_text.length > 1500) {\n    whatsapp_text = whatsapp_text.substring(0, 1497) + '...';\n  }\n}\n\n// Agregar header personalizado para WhatsApp si hay serial\nif (data.serial && whatsapp_text) {\n  whatsapp_text = `ðŸ“‹ *Incapacidad ${data.serial}*\\n\\n${whatsapp_text}\\n\\n_Mensaje automÃ¡tico - IncaNeurobaeza_`;\n}\n\nconsole.log('ðŸ“§ Email TO:', data.email);\nconsole.log('ðŸ“§ Email CCs:', cc_emails);\nconsole.log('ðŸ“± WhatsApp nÃºmeros:', whatsapp_numbers);\nconsole.log('ðŸ“± WhatsApp texto (preview):', whatsapp_text.substring(0, 100));\nconsole.log('ðŸ“‹ Serial:', data.serial);\n\nreturn {\n  json: {\n    // Datos email (originales)\n    email: data.email,\n    subject: data.subject,\n    html_content: data.html_content,\n    cc_emails: cc_emails,\n    serial: data.serial,\n    tipo_notificacion: data.tipo_notificacion,\n    \n    // Datos WhatsApp (nuevos)\n    whatsapp_numbers: whatsapp_numbers,\n    whatsapp_text: whatsapp_text,\n    \n    // Flags de control\n    send_email: data.email && data.email.trim().length > 0,\n    send_whatsapp: whatsapp_numbers.length > 0\n  }\n};"
      },
      "id": "f8275272-4804-4cc4-a089-4270f24c20cd",
      "name": "Procesar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        112
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html_content }}",
        "options": {
          "ccList": "={{ $json.cc_emails.length > 0 ? $json.cc_emails.join(', ') : '' }}"
        }
      },
      "id": "3114ed18-991f-454f-8dba-e36015dace1c",
      "name": "Gmail Sender",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "webhookId": "1626ebb5-68b9-4e76-81ae-43629dee7cc5",
      "credentials": {
        "gmailOAuth2": {
          "id": "7ziI5RBrF78AuzTr",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "whatsapp_condition",
              "leftValue": "={{ $json.send_whatsapp }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d89a720f-0d75-4bea-867e-ea527fe866b5",
      "name": "Â¿Enviar WhatsApp?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        0,
        208
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "whatsapp_numbers",
        "options": {}
      },
      "id": "be8a4fd3-952b-480f-940b-cf4799b4e8ad",
      "name": "Split WhatsApp Numbers",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        208,
        208
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://devlikeaprowaha-production-111a.up.railway.app/api/sendText",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"session\": \"default\",\n  \"chatId\": \"{{ $json }}@c.us\",\n  \"text\": \"{{ $('Procesar Datos').first().json.whatsapp_text }}\"\n}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 2000
            }
          }
        }
      },
      "id": "e9140ad3-dd9a-4240-9bac-241ab5d3d542",
      "name": "WAHA - Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        208
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "jTS0vO9s08ycQzUi",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Recopilar resultados de TODOS los canales\nconst allInputs = $input.all();\nconst originalData = $('Procesar Datos').first().json;\n\n// Detectar emails (tienen threadId o id de Gmail)\nconst emailResults = allInputs.filter(item => \n  item.json.threadId || \n  (item.json.id && typeof item.json.id === 'string' && item.json.id.length > 10)\n);\n\n// Detectar WhatsApp (tienen key.id o messageId de Evolution API)\nconst whatsappResults = allInputs.filter(item => \n  (item.json.key && item.json.key.id) || \n  item.json.messageId\n);\n\nlet response = {\n  status: 'success',\n  serial: originalData.serial || 'N/A',\n  timestamp: new Date().toISOString(),\n  channels: {}\n};\n\n// ========== RESULTADOS EMAIL ==========\nif (emailResults.length > 0) {\n  response.channels.email = {\n    sent: true,\n    to: originalData.email,\n    cc: originalData.cc_emails || [],\n    message_id: emailResults[0].json.id || emailResults[0].json.threadId || 'unknown'\n  };\n} else if (originalData.send_email) {\n  response.channels.email = {\n    sent: false,\n    error: 'Email no enviado',\n    to: originalData.email\n  };\n}\n\n// ========== RESULTADOS WHATSAPP ==========\nif (whatsappResults.length > 0) {\n  const successCount = whatsappResults.filter(r => \n    (r.json.key && r.json.key.id) || r.json.messageId\n  ).length;\n  \n  response.channels.whatsapp = {\n    sent: true,\n    total_numbers: originalData.whatsapp_numbers ? originalData.whatsapp_numbers.length : 0,\n    successful: successCount,\n    failed: (originalData.whatsapp_numbers ? originalData.whatsapp_numbers.length : 0) - successCount,\n    numbers: originalData.whatsapp_numbers || []\n  };\n} else if (originalData.send_whatsapp) {\n  response.channels.whatsapp = {\n    sent: false,\n    error: 'WhatsApp no enviado',\n    numbers: originalData.whatsapp_numbers || []\n  };\n}\n\n// Log para debugging\nconsole.log('ðŸ“Š Respuesta final:', JSON.stringify(response, null, 2));\n\nreturn { json: response };"
      },
      "id": "31bb4007-8a53-4e77-b50f-68fe2ae912d0",
      "name": "Preparar Respuesta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        112
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "8012e3cc-5086-4a10-a90d-424f18b2736a",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        800,
        112
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Procesar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Datos": {
      "main": [
        [
          {
            "node": "Gmail Sender",
            "type": "main",
            "index": 0
          },
          {
            "node": "Â¿Enviar WhatsApp?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Sender": {
      "main": [
        [
          {
            "node": "Preparar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿Enviar WhatsApp?": {
      "main": [
        [
          {
            "node": "Split WhatsApp Numbers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split WhatsApp Numbers": {
      "main": [
        [
          {
            "node": "Evolution API - Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evolution API - Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "Preparar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Respuesta": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ecf2c6bc-ec09-4f57-8357-44fa641ebee3",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "ce56d5b94f7a825d01345f6a261f6a17ae238fa63e9978e8a5e31a6143469e93"
  },
  "id": "ORVC3ZPa2poydpTC",
  "tags": []
}